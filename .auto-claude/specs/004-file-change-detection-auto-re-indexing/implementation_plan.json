{
  "feature": "File Change Detection & Auto Re-indexing",
  "description": "Implement file system watchers to detect when files change and automatically update the index incrementally. Support debouncing to batch rapid changes and provide notifications when re-indexing completes.",
  "workflow_type": "feature",
  "workflow_rationale": "This is a feature workflow because we're adding new functionality (file watching and auto-reindexing) to the existing codebase. The implementation spans multiple services (core watcher and MCP server integration) with clear dependencies: the core watcher must be built before it can be integrated into the MCP server. The phases follow the natural flow: Core watcher implementation \u2192 Configuration \u2192 MCP integration \u2192 Testing.",
  "phases": [
    {
      "id": "phase-1-core-watcher",
      "name": "Core File Watcher Implementation",
      "type": "implementation",
      "description": "Build the file watching infrastructure with debouncing. This core service will monitor file system changes and trigger incremental re-indexing.",
      "depends_on": [],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create FileWatcher types and interfaces",
          "service": "core",
          "files_to_create": [
            "packages/core/src/watcher/types.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "packages/core/src/vectordb/types.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/core && yarn build 2>&1 | grep -i 'error\\|success' || echo 'Build completed'",
            "expected": "Build completed"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-2",
          "description": "Implement FileWatcher class with chokidar integration and debouncing",
          "service": "core",
          "files_to_create": [
            "packages/core/src/watcher/file-watcher.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "packages/core/src/sync/synchronizer.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/core && npx tsc --noEmit src/watcher/file-watcher.ts 2>&1 | grep -i 'error' || echo 'Type check passed'",
            "expected": "Type check passed"
          },
          "status": "completed"
        },
        {
          "id": "subtask-1-3",
          "description": "Export FileWatcher from core package index",
          "service": "core",
          "files_to_modify": [
            "packages/core/src/index.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/core/src/index.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/core && yarn build && grep -q 'FileWatcher' dist/index.d.ts && echo 'Export found' || echo 'Export missing'",
            "expected": "Export found"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-2-integration",
      "name": "Context Integration",
      "type": "implementation",
      "description": "Integrate FileWatcher into Context class and connect it with existing reindexByChange() method.",
      "depends_on": [
        "phase-1-core-watcher"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Add FileWatcher instance and start/stop methods to Context class",
          "service": "core",
          "files_to_modify": [
            "packages/core/src/context.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/core/src/context.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/core && npx tsc --noEmit src/context.ts 2>&1 | grep -i 'error' || echo 'Type check passed'",
            "expected": "Type check passed"
          },
          "status": "completed"
        },
        {
          "id": "subtask-2-2",
          "description": "Wire up FileWatcher change events to call reindexByChange() with debouncing",
          "service": "core",
          "files_to_modify": [
            "packages/core/src/context.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/core/src/context.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/core && yarn build && echo 'Build completed'",
            "expected": "Build completed"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-3-configuration",
      "name": "Configuration & Environment",
      "type": "implementation",
      "description": "Add environment variable support for enabling/disabling file watching and configuring debouncing interval.",
      "depends_on": [
        "phase-2-integration"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Add ENABLE_FILE_WATCHER and FILE_WATCH_DEBOUNCE_MS to .env.example and config types",
          "service": "mcp",
          "files_to_modify": [
            ".env.example",
            "packages/mcp/src/config.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/mcp/src/config.ts"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'ENABLE_FILE_WATCHER' .env.example && grep -q 'FILE_WATCH_DEBOUNCE_MS' .env.example && echo 'Env vars found' || echo 'Env vars missing'",
            "expected": "Env vars found"
          },
          "status": "completed"
        },
        {
          "id": "subtask-3-2",
          "description": "Update ContextMcpConfig interface to include file watcher settings",
          "service": "mcp",
          "files_to_modify": [
            "packages/mcp/src/config.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/mcp/src/config.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/mcp && npx tsc --noEmit src/config.ts 2>&1 | grep -i 'error' || echo 'Type check passed'",
            "expected": "Type check passed"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-4-mcp-integration",
      "name": "MCP Server Integration",
      "type": "implementation",
      "description": "Integrate FileWatcher into MCP server, start watchers for indexed codebases, and provide MCP tools for control.",
      "depends_on": [
        "phase-2-integration",
        "phase-3-configuration"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Integrate FileWatcher initialization in MCP server startup with config support",
          "service": "mcp",
          "files_to_modify": [
            "packages/mcp/src/index.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/mcp/src/index.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/mcp && npx tsc --noEmit src/index.ts 2>&1 | grep -i 'error' || echo 'Type check passed'",
            "expected": "Type check passed"
          },
          "status": "completed"
        },
        {
          "id": "subtask-4-2",
          "description": "Start FileWatcher for codebases when they are indexed (in handleIndexCodebase)",
          "service": "mcp",
          "files_to_modify": [
            "packages/mcp/src/handlers.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/mcp/src/handlers.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/mcp && npx tsc --noEmit src/handlers.ts 2>&1 | grep -i 'error' || echo 'Type check passed'",
            "expected": "Type check passed"
          },
          "status": "completed"
        },
        {
          "id": "subtask-4-3",
          "description": "Stop FileWatcher when codebase is cleared (in handleClearIndex)",
          "service": "mcp",
          "files_to_modify": [
            "packages/mcp/src/handlers.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/mcp/src/handlers.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/mcp && npx tsc --noEmit src/handlers.ts 2>&1 | grep -i 'error' || echo 'Type check passed'",
            "expected": "Type check passed"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-5-notifications",
      "name": "MCP Notifications",
      "type": "implementation",
      "description": "Implement notification system to alert MCP clients when auto-re-indexing completes.",
      "depends_on": [
        "phase-4-mcp-integration"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Add notification logging in Context when re-indexing completes from file watcher",
          "service": "core",
          "files_to_modify": [
            "packages/core/src/context.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/core/src/context.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/core && npx tsc --noEmit src/context.ts 2>&1 | grep -i 'error' || echo 'Type check passed'",
            "expected": "Type check passed"
          },
          "status": "completed"
        },
        {
          "id": "subtask-5-2",
          "description": "Add MCP tool descriptions for file watching status and control",
          "service": "mcp",
          "files_to_modify": [
            "packages/mcp/src/index.ts"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/mcp/src/index.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/mcp && yarn build && echo 'Build completed'",
            "expected": "Build completed"
          },
          "status": "completed"
        }
      ]
    },
    {
      "id": "phase-6-dependencies",
      "name": "Dependencies & Build Setup",
      "type": "implementation",
      "description": "Add chokidar dependency to package.json and ensure build process compiles new files.",
      "depends_on": [
        "phase-1-core-watcher"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "Add chokidar dependency to packages/core/package.json",
          "service": "core",
          "files_to_modify": [
            "packages/core/package.json"
          ],
          "files_to_create": [],
          "patterns_from": [
            "packages/core/package.json"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'chokidar' packages/core/package.json && echo 'Dependency added' || echo 'Dependency missing'",
            "expected": "Dependency added"
          },
          "status": "completed"
        },
        {
          "id": "subtask-6-2",
          "description": "Install dependencies and verify build compiles new watcher files",
          "service": "core",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pnpm install && cd packages/core && yarn build 2>&1 | tail -5",
            "expected": "Successfully built"
          },
          "status": "completed",
          "notes": "Fixed TypeScript errors: 1) Type declaration for options to handle optional ignored parameter, 2) Conditionally pass ignored to chokidar, 3) Fixed handleReady() to count files correctly. Build now compiles successfully."
        }
      ]
    },
    {
      "id": "phase-7-testing",
      "name": "Testing & Verification",
      "type": "integration",
      "description": "Create unit tests for FileWatcher, test debouncing behavior, and verify end-to-end file watching flow.",
      "depends_on": [
        "phase-4-mcp-integration",
        "phase-5-notifications",
        "phase-6-dependencies"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-7-1",
          "description": "Create unit tests for FileWatcher class (chokidar integration, debouncing, change detection)",
          "service": "core",
          "files_to_create": [
            "packages/core/src/__tests__/watcher/file-watcher.test.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "packages/core/src/__tests__/sync/synchronizer.test.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/core && yarn test -- --testPathPattern=file-watcher 2>&1 | grep -E 'PASS|FAIL|Tests:'",
            "expected": "PASS"
          },
          "status": "pending"
        },
        {
          "id": "subtask-7-2",
          "description": "Create integration test for file watching + auto re-indexing flow",
          "service": "core",
          "files_to_create": [
            "packages/core/src/__tests__/integration/file-watching-integration.test.ts"
          ],
          "files_to_modify": [],
          "patterns_from": [
            "packages/core/src/__tests__/integration/indexing-search.test.ts"
          ],
          "verification": {
            "type": "command",
            "command": "cd packages/core && yarn test -- --testPathPattern=file-watching-integration 2>&1 | grep -E 'PASS|FAIL|Tests:'",
            "expected": "PASS"
          },
          "status": "pending"
        },
        {
          "id": "subtask-7-3",
          "description": "Manual verification test: Create test repo, index it, modify files, verify auto-reindex works",
          "service": "core",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "1. Create temporary test directory with sample TypeScript files\n2. Start MCP server with ENABLE_FILE_WATCHER=true\n3. Index the test directory using index_codebase tool\n4. Modify a file in the test directory\n5. Wait 2+ seconds (debounce interval)\n6. Verify logs show 'Re-indexing complete' with correct counts\n7. Search for the modified content to verify it was re-indexed\n8. Clean up test directory"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-8-documentation",
      "name": "Documentation & Examples",
      "type": "cleanup",
      "description": "Update documentation with file watching feature, add examples to .env.example, and create README section.",
      "depends_on": [
        "phase-7-testing"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-8-1",
          "description": "Update README.md with file watching feature documentation",
          "service": "mcp",
          "files_to_modify": [
            "README.md"
          ],
          "files_to_create": [],
          "patterns_from": [
            "README.md"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review README.md to ensure:\n1. File watching feature is clearly explained\n2. Environment variables are documented\n3. Usage examples are provided\n4. Limitations and known issues are noted"
          },
          "status": "pending"
        },
        {
          "id": "subtask-8-2",
          "description": "Update .env.example with descriptive comments for file watching variables",
          "service": "mcp",
          "files_to_modify": [
            ".env.example"
          ],
          "files_to_create": [],
          "patterns_from": [
            ".env.example"
          ],
          "verification": {
            "type": "command",
            "command": "grep -A2 'ENABLE_FILE_WATCHER' .env.example | grep -q 'File system watching' && echo 'Documentation found' || echo 'Documentation missing'",
            "expected": "Documentation found"
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 8,
    "total_subtasks": 21,
    "services_involved": [
      "core",
      "mcp"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-3-configuration",
            "phase-5-notifications",
            "phase-6-dependencies"
          ],
          "reason": "All depend on phase-2-integration but don't conflict with each other"
        },
        {
          "phases": [
            "phase-8-documentation"
          ],
          "reason": "Can run in parallel with other cleanup tasks once testing is complete"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution recommended due to tight dependencies between core and MCP services"
    },
    "startup_command": "pnpm install && cd packages/core && yarn build && cd ../mcp && yarn build"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration",
      "manual"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "New FileWatcher tests pass (unit + integration)",
      "File watching can be enabled/disabled via environment variable",
      "Debouncing batches rapid changes within 2-second window",
      "Only changed files are re-indexed (incremental, not full)",
      "Auto-reindexing runs in background without blocking searches",
      "MCP clients receive notifications when re-indexing completes"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests",
        "command": "cd packages/core && yarn test",
        "expected_outcome": "All tests pass including new FileWatcher tests",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests",
        "command": "cd packages/core && yarn test -- --testPathPattern=integration",
        "expected_outcome": "All integration tests pass including file watching integration test",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Type Checking",
        "command": "cd packages/core && yarn typecheck && cd ../mcp && yarn typecheck",
        "expected_outcome": "No TypeScript errors in core or MCP packages",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Manual Verification",
        "command": "See subtask-7-3 for manual test instructions",
        "expected_outcome": "File changes trigger auto-reindex within 2 seconds, only changed files are re-indexed",
        "type": "manual",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "Medium risk change involves adding new file watching infrastructure that integrates with existing indexing and MCP systems. While incremental re-indexing already exists, the automatic file watching is new functionality that could affect performance and stability. Unit tests ensure FileWatcher works correctly, integration tests verify the end-to-end flow, and manual testing confirms real-world behavior with actual file system changes."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "cd packages/core && yarn test -- --testPathPattern=file-watcher"
      ],
      "minimum_coverage": null,
      "test_files": [
        "packages/core/src/__tests__/watcher/file-watcher.test.ts"
      ]
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "cd packages/core && yarn test -- --testPathPattern=file-watching-integration"
      ],
      "services_to_test": [
        "core",
        "mcp"
      ],
      "test_files": [
        "packages/core/src/__tests__/integration/file-watching-integration.test.ts"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "manual_verification": {
      "required": true,
      "instructions": [
        "Create test repository with sample files",
        "Start MCP server with ENABLE_FILE_WATCHER=true",
        "Index test repository",
        "Modify files and verify auto-reindex triggers within 2 seconds",
        "Verify only changed files are re-indexed (check counts)",
        "Verify searches return updated content",
        "Test with ENABLE_FILE_WATCHER=false to verify feature can be disabled",
        "Test rapid file changes are debounced (batched)"
      ]
    },
    "build_verification": {
      "required": true,
      "checks": [
        "packages/core builds successfully",
        "packages/mcp builds successfully",
        "TypeScript compilation succeeds",
        "chokidar dependency installed"
      ]
    }
  },
  "qa_signoff": null,
  "status": "in_progress",
  "planStatus": "in_progress",
  "updated_at": "2026-01-20T16:52:00.000Z"
}